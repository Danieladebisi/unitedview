<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>United View | Player Ratings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            overflow-x: hidden;
        }

        .background-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(220, 38, 38, 0.15) 0%, rgba(220, 38, 38, 0) 60%);
            transform: translate(-50%, -50%);
            z-index: 0;
        }
        
        .main-container {
            position: relative;
            z-index: 1;
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #374151; /* bg-gray-700 */
            border-radius: 5px;
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: #FFF;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.15s ease-in-out;
        }
        
        input[type=range]:hover::-webkit-slider-thumb {
            transform: scale(1.2);
        }

        .rating-bar-fill {
            background: linear-gradient(90deg, #dc2626, #ef4444);
            transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            animation: fill-bar 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .player-card, .result-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }

        .motm-card {
            background-color: rgba(252, 211, 77, 0.1);
            border-color: #f59e0b; /* amber-500 */
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease-in-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .live-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="background-glow"></div>

    <div id="app-container" class="w-full max-w-2xl main-container rounded-2xl shadow-2xl p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-black tracking-tighter text-white">UNITED VIEW</h1>
            <p class="text-lg text-red-500 font-bold">POST-MATCH RATINGS</p>
            <h2 id="match-title" class="text-xl md:text-2xl font-semibold mt-4 text-gray-300">Manchester United vs. Rival FC</h2>
        </header>

        <div id="loading" class="flex flex-col items-center justify-center py-10">
            <svg class="animate-spin h-10 w-10 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-400">Loading Match Data...</p>
        </div>
        
        <div id="ratings-container" class="hidden">
            <h3 class="text-xl font-bold text-white mb-3 border-b-2 border-red-500 pb-2">Starting XI</h3>
            <div id="starters-list" class="space-y-4 mb-6">
                <!-- Starting XI cards will be injected here -->
            </div>
            
            <h3 class="text-xl font-bold text-white mb-3 mt-8 border-b-2 border-gray-600 pb-2">Substitutes</h3>
            <div id="subs-list" class="space-y-4 mb-6">
                <!-- Substitutes cards will be injected here -->
            </div>

            <button id="submit-ratings" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-4 rounded-lg text-lg transition-all duration-300 shadow-lg hover:shadow-red-500/50 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:shadow-none">
                Submit Your Ratings
            </button>
        </div>

        <div id="results-container" class="hidden mt-8">
            <h3 class="text-2xl font-bold text-center mb-4 flex items-center justify-center gap-2 text-white">
                <span class="w-3 h-3 bg-red-500 rounded-full live-indicator"></span>
                Live Fan Ratings
            </h3>
            <div id="results-list" class="space-y-3">
                <!-- Result cards will be injected here -->
            </div>
            <button id="rate-again" class="w-full mt-6 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300">
                Change Your Ratings
            </button>
        </div>

        <div id="message-box" class="hidden mt-4 p-4 text-center rounded-lg font-semibold"></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIza...", authDomain: "...", projectId: "...", ...{/* ADD YOUR FIREBASE CONFIG FOR LOCAL TESTING */} };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'player-ratings-demo';
        
        // --- App State ---
        let db, auth;
        let userId;
        let currentMatchId = 'manutd-vs-rival-fc-20250912';
        let unsubscribeRatings; 

        // --- Mock Data (Updated Squad) ---
        const startingXI = [
            { id: 'onana', name: 'André Onana' },
            { id: 'dalot', name: 'Diogo Dalot' },
            { id: 'deligt', name: 'Matthijs de Ligt' },
            { id: 'martinez', name: 'Lisandro Martínez' },
            { id: 'shaw', name: 'Luke Shaw' },
            { id: 'ugarte', name: 'Manuel Ugarte' },
            { id: 'mainoo', name: 'Kobbie Mainoo' },
            { id: 'fernandes', name: 'Bruno Fernandes' },
            { id: 'mbeumo', name: 'Bryan Mbeumo' },
            { id: 'cunha', name: 'Matheus Cunha' },
            { id: 'sesko', name: 'Benjamin Šeško' },
        ];
        
        const substitutes = [
            { id: 'lammens', name: 'Senne Lammens' },
            { id: 'bayindir', name: 'Altay Bayındır' },
            { id: 'heaton', name: 'Tom Heaton' },
            { id: 'leon', name: 'Diego León' },
            { id: 'dorgu', name: 'Patrick Dorgu' },
            { id: 'yoro', name: 'Leny Yoro' },
            { id: 'maguire', name: 'Harry Maguire' },
            { id: 'heaven', name: 'Ayden Heaven' },
            { id: 'malacia', name: 'Tyrell Malacia' },
            { id: 'fredricson', name: 'Tyler Fredricson' },
            { id: 'mazraoui', name: 'Noussair Mazraoui' },
            { id: 'casemiro', name: 'Casemiro' },
            { id: 'mount', name: 'Mason Mount' },
            { id: 'diallo', name: 'Amad Diallo' },
            { id: 'zirkzee', name: 'Joshua Zirkzee' },
            { id: 'obi', name: 'Chido Obi' },
        ];

        // --- UI Elements ---
        const loadingDiv = document.getElementById('loading');
        const ratingsContainer = document.getElementById('ratings-container');
        const resultsContainer = document.getElementById('results-container');
        const startersList = document.getElementById('starters-list');
        const subsList = document.getElementById('subs-list');
        const resultsList = document.getElementById('results-list');
        const submitBtn = document.getElementById('submit-ratings');
        const rateAgainBtn = document.getElementById('rate-again');
        const messageBox = document.getElementById('message-box');

        // --- Functions ---

        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = `mt-4 p-4 text-center rounded-lg font-semibold ${type === 'success' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 3000);
        }

        function renderPlayerInputs(starters, subs) {
            const createPlayerHTML = (player) => `
                <div class="player-card bg-gray-900/70 p-4 rounded-lg flex flex-col sm:flex-row items-center justify-between gap-4 border border-gray-700 fade-in-up">
                    <p class="text-lg font-bold text-white whitespace-nowrap">${player.name}</p>
                    <div class="flex items-center space-x-4 w-full sm:w-auto">
                        <input type="range" id="player-${player.id}" data-player-id="${player.id}" min="1" max="10" value="5" class="w-full max-w-[200px]">
                        <span id="rating-value-${player.id}" class="font-black text-2xl w-10 text-center text-red-400">5</span>
                    </div>
                </div>
            `;
            
            startersList.innerHTML = starters.map(createPlayerHTML).join('');
            subsList.innerHTML = subs.map(createPlayerHTML).join('');
            
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                slider.addEventListener('input', (e) => {
                    document.getElementById(`rating-value-${e.target.dataset.playerId}`).textContent = e.target.value;
                });
            });
        }
        
        function renderResults(playersData) {
            const sortedPlayers = Object.entries(playersData)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => {
                    const avgA = a.voteCount > 0 ? a.totalScore / a.voteCount : 0;
                    const avgB = b.voteCount > 0 ? b.totalScore / b.voteCount : 0;
                    return avgB - avgA;
                });

            resultsList.innerHTML = sortedPlayers.map((player, index) => {
                const average = player.voteCount > 0 ? (player.totalScore / player.voteCount).toFixed(1) : '0.0';
                const width = player.voteCount > 0 ? (parseFloat(average) / 10) * 100 : 0;
                const isMotm = index === 0 && player.voteCount > 0;

                return `
                    <div class="result-card bg-gray-900/70 p-4 rounded-lg border border-gray-700 fade-in-up ${isMotm ? 'motm-card' : ''}">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg text-white">${player.name} ${isMotm ? '⭐' : ''}</span>
                            <div class="flex items-baseline gap-2">
                                <span class="font-black text-2xl text-white">${average}</span>
                                <span class="text-sm text-gray-400">/ 10</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="rating-bar-fill h-2.5 rounded-full" style="width: ${width}%"></div>
                        </div>
                        <div class="text-right text-xs text-gray-500 mt-1">${player.voteCount} votes</div>
                    </div>
                `;
            }).join('');
        }

        async function initializeMatchData() {
            const matchRef = doc(db, `artifacts/${appId}/public/data/player_ratings/${currentMatchId}`);
            try {
                await runTransaction(db, async (transaction) => {
                    const matchDoc = await transaction.get(matchRef);
                    if (matchDoc.exists() && matchDoc.data().setupComplete) return;

                    const playersMap = {};
                    const allPlayers = [...startingXI, ...substitutes];
                    allPlayers.forEach(player => {
                        playersMap[player.id] = { name: player.name, totalScore: 0, voteCount: 0 };
                    });

                    transaction.set(matchRef, { 
                        title: document.getElementById('match-title').textContent, 
                        createdAt: serverTimestamp(), 
                        setupComplete: true,
                        players: playersMap
                    });
                });
            } catch (error) {
                console.error("Error initializing match data: ", error);
                showMessage("Could not initialize match data.", "error");
            }
        }

        async function handleSubmitRatings() {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const userRatings = {};
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                userRatings[slider.dataset.playerId] = parseInt(slider.value, 10);
            });

            try {
                const matchRef = doc(db, `artifacts/${appId}/public/data/player_ratings/${currentMatchId}`);
                await runTransaction(db, async (transaction) => {
                    const matchDoc = await transaction.get(matchRef);
                    if (!matchDoc.exists()) throw "Match document does not exist!";

                    const players = matchDoc.data().players;
                    Object.keys(userRatings).forEach(playerId => {
                        if (players[playerId]) {
                            players[playerId].totalScore += userRatings[playerId];
                            players[playerId].voteCount += 1;
                        }
                    });
                    
                    transaction.update(matchRef, { players });
                });
                
                localStorage.setItem(`voted_${currentMatchId}`, 'true');
                ratingsContainer.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                showMessage('Your ratings have been submitted!', 'success');
            } catch (error) {
                console.error("Transaction failed: ", error);
                showMessage('Error submitting ratings. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Your Ratings';
            }
        }
        
        function listenForRatings() {
            const matchRef = doc(db, `artifacts/${appId}/public/data/player_ratings/${currentMatchId}`);
            if (unsubscribeRatings) unsubscribeRatings();

            unsubscribeRatings = onSnapshot(matchRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().players) {
                    renderResults(docSnap.data().players);
                    
                    loadingDiv.classList.add('hidden');
                    const hasVoted = localStorage.getItem(`voted_${currentMatchId}`);
                    if (hasVoted) {
                        ratingsContainer.classList.add('hidden');
                        resultsContainer.classList.remove('hidden');
                    } else {
                        resultsContainer.classList.add('hidden');
                        ratingsContainer.classList.remove('hidden');
                    }
                }
            }, (error) => {
                console.error("Error listening to ratings: ", error);
                showMessage("Could not connect to live ratings.", "error");
                loadingDiv.textContent = "Error loading data.";
            });
        }

        submitBtn.addEventListener('click', handleSubmitRatings);
        rateAgainBtn.addEventListener('click', () => {
            localStorage.removeItem(`voted_${currentMatchId}`);
            resultsContainer.classList.add('hidden');
            ratingsContainer.classList.remove('hidden');
            showMessage("You can now change your ratings.", 'success');
        });

        (async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        renderPlayerInputs(startingXI, substitutes);
                        await initializeMatchData(); 
                        listenForRatings();
                    }
                });

                if (!auth.currentUser) {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) await signInWithCustomToken(auth, token);
                    else await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                loadingDiv.textContent = 'Failed to initialize the application.';
                showMessage('Could not connect to the server.', 'error');
            }
        })();
    </script>

</body>
</html>